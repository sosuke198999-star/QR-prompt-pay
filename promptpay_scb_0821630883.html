<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PromptPay — SCB優先リンク + QR（082-163-0883）</title>
  <style>
    :root { --maxw: 720px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; color: #111; }
    header { padding: 20px; background: #f5f7fb; border-bottom: 1px solid #e7e9ef; }
    main { margin: 0 auto; max-width: var(--maxw); padding: 20px; }
    h1 { margin: 0; font-size: 20px; }
    .card { border: 1px solid #e7e9ef; border-radius: 12px; padding: 16px; margin: 16px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1 1 auto; }
    .btn { display: inline-block; padding: 12px 16px; border-radius: 10px; border: 1px solid #d3d7e2; background: #fff; cursor: pointer; text-decoration: none; text-align: center; }
    .btn.primary { background: #2e5cff; color: #fff; border-color: #2e5cff; }
    .btn.ghost { background: transparent; }
    .muted { color: #666; font-size: 13px; }
    .qrwrap { text-align: center; }
    img.qr { width: 280px; height: 280px; image-rendering: pixelated; border-radius: 8px; border: 1px solid #e7e9ef; }
    code { background: #f5f7fb; padding: 2px 6px; border-radius: 6px; }
    .banks { display:flex; gap: 8px; flex-wrap: wrap; }
    .banks .btn { flex: 1 1 160px; }
    .kvs { display:grid; grid-template-columns: 160px 1fr; gap: 8px; }
    .kvs div { padding: 6px 0; }
    footer { margin: 40px auto; max-width: var(--maxw); padding: 0 20px 40px; color:#777; font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>PromptPay — ลิงก์เปิดแอปธนาคาร (SCB優先) + คิวอาร์สำรอง</h1>
    <div class="muted">ID: 082-163-0883｜優先: SCB｜金額指定なし（任意で後から入力）</div>
  </header>
  <main>
    <section class="card">
      <h2 style="margin-top:0">1) 自動でアプリを開く（SCBを最優先）</h2>
      <p class="muted">アプリが開かない場合は、下のQRをそのままスキャンしてください。</p>
      <div class="row">
        <button class="btn primary" id="btnAuto">ลองเปิดแอปธนาคาร / Open bank app</button>
        <button class="btn" id="btnShowQr">QRをすぐ表示</button>
      </div>
      <div class="banks" style="margin-top:12px">
        <a class="btn ghost" href="#" id="btnSCB">เปิด SCB</a>
        <a class="btn ghost" href="#" id="btnKBank">開く K PLUS</a>
        <a class="btn ghost" href="#" id="btnBBL">開く Bangkok Bank</a>
        <a class="btn ghost" href="#" id="btnKTB">開く Krungthai NEXT</a>
        <a class="btn ghost" href="#" id="btnBAY">開く Krungsri (KMA)</a>
      </div>
    </section>

    <section class="card qrwrap">
      <h2 style="margin-top:0">2) スキャン用 PromptPay QR</h2>
      <img id="qr" class="qr" alt="PromptPay QR" src="">
      <div style="margin-top:10px">
        <button class="btn" id="btnCopy">EMVペイロードをコピー</button>
      </div>
      <div class="muted" id="payloadBox" style="margin-top:8px; word-break: break-all;"></div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">メモ</h3>
      <ul>
        <li>金額を固定したい場合は、このファイル内の <code>CONFIG.amount</code> に数値を入れて再配布してください。</li>
        <li>もしくはパラメータ版（別ファイル）を使って <code>?amount=...</code> を付与する運用も可能です。</li>
      </ul>
    </section>
  </main>
  <footer>
    * 各銀行のディープリンク仕様は統一されていないため、このページは「アプリ起動の試行」＋「失敗時QR」の2段構えです。
  </footer>

<script>
/* ===== 固定CONFIG（このファイルはあなた専用） ===== */
const CONFIG = {
  promptpayId: "082-163-0883",
  amount: null, // 固定額なし。必要なら 299.00 などを設定
  reference: "",
  tryBanks: ["SCB","KBank","BBL","KTB","BAY"] // SCBを最優先
};

/* ===== EMVCo/Thai QR (PromptPay) ペイロード生成 ===== */
function toTag(t, v) { const len = String(v.length).padStart(2,'0'); return t + len + v; }
function normalizePromptPayId(id) {
  const s = String(id).replace(/\D/g,'');
  if (s.startsWith("66")) return s;
  if (s.startsWith("0")) return "66" + s.slice(1);
  return s;
}
function buildPromptPayPayload(id, amount) {
  const promptpayAppId = "A000000677010111"; // AID
  const target = normalizePromptPayId(id);
  const acc = toTag("00", promptpayAppId) + toTag("01", target);
  const tag26 = toTag("26", acc);
  const tag00 = toTag("00", "01");
  const tag01 = toTag("01", amount ? "11" : "12");
  const tag52 = toTag("52", "0000");
  const tag53 = toTag("53", "764");
  const tag58 = toTag("58", "TH");
  const tag54 = amount ? toTag("54", String(Number(amount).toFixed(2))) : "";
  const msg = tag00 + tag01 + tag26 + tag52 + tag53 + tag54 + tag58;
  const msgForCrc = msg + "6304";
  const crc = crc16ccitt(Buffer.from(msgForCrc, "utf8")).toUpperCase();
  const tag63 = "63" + "04" + crc;
  return msg + tag63;
}
function crc16ccitt(bytes) {
  let crc = 0xFFFF;
  for (let i=0; i<bytes.length; i++) {
    crc ^= (bytes[i] << 8);
    for (let j=0; j<8; j++) {
      if (crc & 0x8000) { crc = (crc << 1) ^ 0x1021; }
      else { crc = crc << 1; }
      crc &= 0xFFFF;
    }
  }
  return crc.toString(16).padStart(4,'0');
}
function qrUrl(data) {
  const enc = encodeURIComponent(data);
  return `https://chart.googleapis.com/chart?cht=qr&chs=280x280&chld=M|1&chl=${enc}`;
}

/* ===== Bank Deep Links ===== */
const BANKS = {
  SCB:   { ios: "scbeasy://",        androidPkg: "com.scb.phone",              scheme: "scbeasy://" },
  KBank: { ios: "kplus://",          androidPkg: "com.kasikornbank.kplus",     scheme: "kplus://" },
  BBL:   { ios: "bualuangmbanking://", androidPkg: "com.bbl.mobilebanking",    scheme: "bualuangmbanking://" },
  KTB:   { ios: "ktbnext://",        androidPkg: "com.ktb.mobilebanking",      scheme: "ktbnext://" },
  BAY:   { ios: "krungsri-kma://",   androidPkg: "com.krungsri.kma",           scheme: "krungsri-kma://" },
};
function isIOS() { return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }
function isAndroid() { return /Android/.test(navigator.userAgent); }
function openBankApp(key) {
  const bank = BANKS[key];
  if (!bank) return false;
  if (isAndroid()) {
    const intent = `intent://${bank.scheme.replace("://","")}#Intent;scheme=${bank.scheme.replace("://","")};package=${bank.androidPkg};end`;
    window.location.href = intent;
    return true;
  } else if (isIOS()) {
    window.location.href = bank.ios;
    return true;
  } else {
    return false;
  }
}
function tryAutoOpen() {
  let idx = 0;
  const tryNext = () => {
    if (idx >= CONFIG.tryBanks.length) { showQr(); return; }
    const key = CONFIG.tryBanks[idx++];
    openBankApp(key);
    setTimeout(tryNext, 800);
  };
  tryNext();
}
function showQr() {
  const payload = buildPromptPayPayload(CONFIG.promptpayId, CONFIG.amount);
  const img = document.getElementById('qr');
  img.src = qrUrl(payload);
  document.getElementById('payloadBox').textContent = payload;
}
function copyPayload() {
  const payload = buildPromptPayPayload(CONFIG.promptpayId, CONFIG.amount);
  navigator.clipboard.writeText(payload).then(
    () => alert("คัดลอกเพย์โหลดแล้ว (EMVCo payload copied)."),
    () => alert("คัดลอกไม่สำเร็จ โปรดเลือกとคัดลอกด้วยตนเอง")
  );
}

/* ===== Wire up ===== */
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnAuto').addEventListener('click', tryAutoOpen);
  document.getElementById('btnShowQr').addEventListener('click', showQr);
  document.getElementById('btnCopy').addEventListener('click', copyPayload);
  document.getElementById('btnSCB').addEventListener('click', e => { e.preventDefault(); openBankApp('SCB'); });
  document.getElementById('btnKBank').addEventListener('click', e => { e.preventDefault(); openBankApp('KBank'); });
  document.getElementById('btnBBL').addEventListener('click', e => { e.preventDefault(); openBankApp('BBL'); });
  document.getElementById('btnKTB').addEventListener('click', e => { e.preventDefault(); openBankApp('KTB'); });
  document.getElementById('btnBAY').addEventListener('click', e => { e.preventDefault(); openBankApp('BAY'); });

  // 初期表示でQRも描画
  showQr();
});
</script>
</body>
</html>
